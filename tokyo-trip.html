<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ±äº¬æ—…èªŒ - æ™ºæ…§äº¤é€šæ’åºç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; overflow-x: hidden; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .timeline-container::before {
            content: ''; position: absolute; left: 27px; top: 0; bottom: 0; width: 2px; background: #e2e8f0; z-index: 0;
        }
        .sortable-ghost { opacity: 0.3; background: #e0e7ff; }
        .drag-handle { cursor: grab; }
        .drag-handle:active { cursor: grabbing; }
    </style>
</head>
<body>
    <div id="app" class="max-w-md mx-auto min-h-screen flex flex-col bg-white shadow-2xl relative">
        
        <header class="bg-slate-900 text-white p-6 pb-4 shrink-0 z-20">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-xl font-bold tracking-tight">TOKYO 2025 ğŸ‡¯ğŸ‡µ</h1>
                <button @click="addDay" class="text-xs bg-indigo-600 px-3 py-1.5 rounded-lg">ï¼‹å¤©æ•¸</button>
            </div>
            <div class="flex gap-3 overflow-x-auto hide-scrollbar">
                <button v-for="(day, index) in itineraryData" :key="index"
                    @click="currentDayIndex = index"
                    :class="['flex-none w-14 py-2 rounded-xl text-xs font-bold transition-all', 
                    currentDayIndex === index ? 'bg-indigo-500 text-white' : 'bg-white/10 text-slate-400']">
                    D{{ index + 1 }}
                </button>
            </div>
        </header>

        <main class="flex-grow overflow-y-auto p-4 relative timeline-container bg-slate-50">
            <div id="sortable-list">
                <div v-for="(item, idx) in currentDayItems" :key="item.id" :data-id="item.id" class="relative z-10 mb-4 group">
                    
                    <div v-if="idx > 0" class="ml-14 -mt-2 mb-4 flex items-center gap-2 pointer-events-none">
                        <span class="text-[10px] font-bold text-indigo-400 bg-white border border-indigo-100 px-2 py-0.5 rounded-full shadow-sm">
                            é–“éš” {{ formatGap(idx) }}
                        </span>
                    </div>

                    <div class="flex gap-4">
                        <div class="w-10 pt-2 shrink-0 flex flex-col items-center">
                            <div class="drag-handle p-1 text-slate-300 hover:text-slate-600 transition">
                                <i data-lucide="grip-vertical" class="w-4 h-4"></i>
                            </div>
                            <div class="w-3 h-3 rounded-full border-2 border-white shadow-sm my-1"
                                 :class="item.type === 'activity' ? 'bg-indigo-500' : 'bg-orange-400'"></div>
                        </div>

                        <div class="flex-grow bg-white rounded-2xl p-4 shadow-sm border border-slate-100 transition-all hover:shadow-md">
                            
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex-grow">
                                    <input v-model="item.title" class="font-bold text-slate-800 bg-transparent outline-none w-full text-lg" placeholder="æ™¯é»/åœ°é»åç¨±">
                                    <div class="flex items-center gap-2 mt-1">
                                        <div class="flex items-center gap-1 bg-slate-100 px-2 py-0.5 rounded text-[10px] font-bold text-slate-500">
                                            <input type="time" v-model="item.start" @change="autoCalculateTime(idx)">
                                            <span>-</span>
                                            <input type="time" v-model="item.end">
                                        </div>
                                        <select v-model="item.category" class="text-[10px] bg-indigo-50 text-indigo-600 px-1 rounded font-bold outline-none">
                                            <option value="activity">æ™¯é»/é¤é£²</option>
                                            <option value="transport">äº¤é€šæ¥é§</option>
                                        </select>
                                    </div>
                                </div>
                                <button @click="confirmDelete(idx)" class="text-slate-300 hover:text-red-500 p-1"><i data-lucide="x" class="w-4 h-4"></i></button>
                            </div>

                            <div v-if="item.category === 'transport'" class="bg-orange-50/50 border border-orange-100 rounded-xl p-3 space-y-2">
                                <div class="flex items-center gap-2">
                                    <select v-model="item.subType" @change="handleTransportChange(item)" class="text-xs font-bold text-orange-700 bg-white border border-orange-200 rounded px-2 py-1 outline-none">
                                        <option value="walk">ğŸš¶ å¾’æ­¥</option>
                                        <option value="taxi">ğŸš• è¨ˆç¨‹è»Š</option>
                                        <option value="metro">ğŸš‡ åœ°éµ</option>
                                        <option value="shinkansen">ğŸš„ æ–°å¹¹ç·š</option>
                                        <option value="flight">âœˆï¸ é£›æ©Ÿ</option>
                                    </select>
                                    <span v-if="item.subType === 'walk' || item.subType === 'taxi'" class="text-[10px] text-orange-400 font-medium">è‡ªå‹•ä¼°ç®—æ™‚é–“ä¸­...</span>
                                </div>

                                <div class="flex flex-col gap-2">
                                    <div v-if="['metro', 'shinkansen'].includes(item.subType)" class="flex items-center gap-2">
                                        <i data-lucide="map-pinned" class="w-3 h-3 text-orange-400"></i>
                                        <input v-model="item.route" class="text-xs bg-transparent border-b border-orange-200 w-full outline-none" placeholder="å»ºè­°è·¯ç·šï¼šéŠ€åº§ç·š(æ·ºè‰è¡Œ)">
                                    </div>
                                    <div v-if="item.subType === 'flight'" class="grid grid-cols-2 gap-2">
                                        <div class="flex items-center gap-1">
                                            <i data-lucide="plane-takeoff" class="w-3 h-3 text-orange-400"></i>
                                            <input v-model="item.flightNo" class="text-xs bg-transparent border-b border-orange-200 w-full outline-none" placeholder="ç­æ¬¡(å¦‚JL802)">
                                        </div>
                                        <input v-model="item.terminal" class="text-xs bg-transparent border-b border-orange-200 w-full outline-none" placeholder="èˆªå»ˆ/ç™»æ©Ÿé–€">
                                    </div>
                                    <textarea v-model="item.details" class="text-[10px] text-orange-600 bg-transparent w-full resize-none outline-none" placeholder="è©³ç´°è³‡è¨Šæˆ–è½‰ä¹˜å‚™è¨»..." rows="1"></textarea>
                                </div>
                            </div>

                            <div v-if="item.category === 'activity'" class="mt-2 flex justify-end">
                                <button @click="openMap(item.title)" class="flex items-center gap-1 text-[10px] bg-slate-100 hover:bg-indigo-50 hover:text-indigo-600 px-3 py-1 rounded-lg transition">
                                    <i data-lucide="map"></i> æŸ¥çœ‹å°èˆª
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="h-32"></div>
        </main>

        <div class="fixed bottom-24 right-6 z-40">
            <button @click="addItem" class="bg-indigo-600 text-white p-4 rounded-full shadow-xl hover:scale-110 active:scale-95 transition">
                <i data-lucide="plus"></i>
            </button>
        </div>

        <nav class="h-20 border-t bg-white flex justify-around items-center shrink-0 z-40">
            <button class="text-indigo-600 flex flex-col items-center"><i data-lucide="calendar"></i><span class="text-[10px] mt-1">è¡Œç¨‹è¡¨</span></button>
            <button @click="alert('åŠŸèƒ½é–‹ç™¼ä¸­')" class="text-slate-300 flex flex-col items-center"><i data-lucide="wallet"></i><span class="text-[10px] mt-1">è¨˜å¸³</span></button>
            <button @click="alert('åŠŸèƒ½é–‹ç™¼ä¸­')" class="text-slate-300 flex flex-col items-center"><i data-lucide="shopping-bag"></i><span class="text-[10px] mt-1">ä»£è³¼</span></button>
        </nav>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                const currentDayIndex = ref(0);
                const showDeleteModal = ref(false);
                const itineraryData = ref([{ id: Date.now(), items: [] }]);

                onMounted(() => {
                    const saved = localStorage.getItem('tokyo_pro_v4');
                    if (saved) itineraryData.value = JSON.parse(saved);
                    else {
                        itineraryData.value = [{ 
                            id: 1, 
                            items: [
                                { id: '1a', title: 'æˆç”°æ©Ÿå ´', start: '08:00', end: '09:00', category: 'activity', details: '' },
                                { id: '1b', title: 'å‰å¾€å¸‚å€', start: '09:00', end: '10:00', category: 'transport', subType: 'metro', route: 'äº¬æˆæˆç”°Skyaccess', details: '' }
                            ] 
                        }];
                    }
                    initSortable();
                    lucide.createIcons();
                });

                const currentDayItems = computed(() => itineraryData.value[currentDayIndex.value]?.items || []);

                // æ ¸å¿ƒï¼šæ‹–æ”¾æ’åºåˆå§‹åŒ–
                const initSortable = () => {
                    nextTick(() => {
                        const el = document.getElementById('sortable-list');
                        Sortable.create(el, {
                            handle: '.drag-handle',
                            animation: 150,
                            ghostClass: 'sortable-ghost',
                            onEnd: (evt) => {
                                const items = [...currentDayItems.value];
                                const [removed] = items.splice(evt.oldIndex, 1);
                                items.splice(evt.newIndex, 0, removed);
                                itineraryData.value[currentDayIndex.value].items = items;
                            }
                        });
                    });
                };

                const timeToMin = (t) => {
                    if(!t) return 0;
                    const [h, m] = t.split(':').map(Number);
                    return h * 60 + m;
                };

                const minToTime = (min) => {
                    const h = Math.floor(min / 60) % 24;
                    const m = min % 60;
                    return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                };

                // æ™ºæ…§è¨ˆç®—äº¤é€šæ™‚é–“
                const handleTransportChange = (item) => {
                    if (item.subType === 'walk') {
                        // æ¨¡æ“¬è¨ˆç®—ï¼šå¾’æ­¥é è¨­ 15 åˆ†é˜
                        const start = timeToMin(item.start);
                        item.end = minToTime(start + 15);
                    } else if (item.subType === 'taxi') {
                        // æ¨¡æ“¬è¨ˆç®—ï¼šè¨ˆç¨‹è»Šé è¨­ 10 åˆ†é˜
                        const start = timeToMin(item.start);
                        item.end = minToTime(start + 10);
                    }
                };

                const formatGap = (idx) => {
                    const prev = currentDayItems.value[idx-1];
                    const curr = currentDayItems.value[idx];
                    const gap = timeToMin(curr.start) - timeToMin(prev.end);
                    if (gap < 0) return 'é‡ç–Š';
                    return gap < 60 ? `${gap}m` : `${Math.floor(gap/60)}h${gap%60}m`;
                };

                const addItem = () => {
                    const lastItem = currentDayItems.value[currentDayItems.value.length - 1];
                    const startTime = lastItem ? lastItem.end : '09:00';
                    const [h, m] = startTime.split(':').map(Number);
                    const endTime = minToTime(timeToMin(startTime) + 60);

                    itineraryData.value[currentDayIndex.value].items.push({
                        id: Date.now().toString(),
                        title: '',
                        start: startTime,
                        end: endTime,
                        category: 'activity',
                        subType: 'walk',
                        route: '',
                        flightNo: '',
                        terminal: '',
                        details: ''
                    });
                    nextTick(() => lucide.createIcons());
                };

                const confirmDelete = (idx) => {
                    if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                        itineraryData.value[currentDayIndex.value].items.splice(idx, 1);
                    }
                };

                const addDay = () => {
                    itineraryData.value.push({ id: Date.now(), items: [] });
                    currentDayIndex.value = itineraryData.value.length - 1;
                };

                watch(itineraryData, (val) => {
                    localStorage.setItem('tokyo_pro_v4', JSON.stringify(val));
                    nextTick(() => lucide.createIcons());
                }, { deep: true });

                const openMap = (loc) => {
                    if(loc) window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`, '_blank');
                };

                return {
                    currentDayIndex, itineraryData, currentDayItems,
                    addItem, addDay, confirmDelete, openMap, formatGap, handleTransportChange
                };
            }
        }).mount('#app');
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ±äº¬æ—…èªŒ - æ™‚é–“è‡ªå‹•æ’åºç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .timeline-container::before {
            content: ''; position: absolute; left: 27px; top: 0; bottom: 0; width: 2px; background: #f1f5f9; z-index: 0;
        }
        /* åˆ—è¡¨éæ¸¡å‹•ç•« */
        .list-move, .list-enter-active, .list-leave-active { transition: all 0.5s ease; }
        .list-enter-from, .list-leave-to { opacity: 0; transform: translateX(30px); }
        
        .drag-handle { cursor: grab; }
        input[type="time"]::-webkit-calendar-picker-indicator { background: transparent; bottom: 0; color: transparent; cursor: pointer; height: auto; left: 0; position: absolute; right: 0; top: 0; width: auto; }
    </style>
</head>
<body>
    <div id="app" class="max-w-md mx-auto min-h-screen flex flex-col bg-white shadow-2xl relative">
        
        <header class="bg-indigo-950 text-white p-6 pb-4 shrink-0 z-20">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-xl font-bold tracking-tight">TOKYO 2025</h1>
                <button @click="addDay" class="text-xs bg-white/10 px-3 py-1.5 rounded-lg border border-white/20">ï¼‹å¤©æ•¸</button>
            </div>
            <div class="flex gap-3 overflow-x-auto no-scrollbar">
                <button v-for="(day, index) in itineraryData" :key="index"
                    @click="currentDayIndex = index"
                    :class="['flex-none w-14 py-2 rounded-xl text-xs font-bold transition-all', 
                    currentDayIndex === index ? 'bg-indigo-500 text-white shadow-lg' : 'bg-white/5 text-slate-400']">
                    D{{ index + 1 }}
                </button>
            </div>
        </header>

        <main class="flex-grow overflow-y-auto p-4 relative timeline-container bg-slate-50">
            
            <transition-group name="list" tag="div" id="sortable-list">
                <div v-for="(item, idx) in sortedItems" :key="item.id" class="relative z-10 mb-6">
                    
                    <div v-if="idx > 0 && getGap(sortedItems[idx-1], item) !== 0" class="ml-14 -mt-2 mb-4 flex items-center gap-2">
                        <span :class="['text-[10px] font-bold px-2 py-0.5 rounded-full border shadow-sm', 
                            getGap(sortedItems[idx-1], item) < 0 ? 'bg-red-50 text-red-500 border-red-100' : 'bg-white text-indigo-400 border-indigo-50']">
                            {{ getGap(sortedItems[idx-1], item) < 0 ? 'æ™‚é–“é‡ç–Š!' : 'ç©ºæª” ' + formatMin(getGap(sortedItems[idx-1], item)) }}
                        </span>
                    </div>

                    <div class="flex gap-4">
                        <div class="w-10 pt-2 shrink-0 flex flex-col items-center">
                            <div class="drag-handle p-1 text-slate-300 hover:text-slate-500"><i data-lucide="grip-vertical" class="w-4 h-4"></i></div>
                            <div class="w-3 h-3 rounded-full border-2 border-white shadow-sm my-1"
                                 :class="item.category === 'activity' ? 'bg-indigo-500' : 'bg-orange-400'"></div>
                            <span class="text-[10px] font-black text-slate-400 mt-1">{{ item.start }}</span>
                        </div>

                        <div class="flex-grow bg-white rounded-2xl p-4 shadow-sm border border-slate-100 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-1 h-full" :class="item.category === 'activity' ? 'bg-indigo-500' : 'bg-orange-400'"></div>

                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-grow">
                                    <input v-model="item.title" class="font-bold text-slate-800 bg-transparent outline-none w-full text-base" placeholder="å»å“ªè£¡ï¼Ÿ">
                                    <div class="flex items-center gap-2 mt-1">
                                        <div class="relative flex items-center gap-1 bg-slate-100 px-2 py-1 rounded text-[10px] font-bold text-slate-600">
                                            <input type="time" v-model="item.start" class="bg-transparent outline-none">
                                            <span>-</span>
                                            <input type="time" v-model="item.end" class="bg-transparent outline-none">
                                        </div>
                                        <select v-model="item.category" class="text-[10px] font-bold bg-slate-100 px-2 py-1 rounded outline-none border-none">
                                            <option value="activity">æ™¯é»/é¤é£²</option>
                                            <option value="transport">äº¤é€šæ¥é§</option>
                                        </select>
                                    </div>
                                </div>
                                <button @click="removeItem(item.id)" class="text-slate-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>

                            <div v-if="item.category === 'transport'" class="mt-3 bg-orange-50 rounded-xl p-3 space-y-2">
                                <select v-model="item.subType" @change="autoTime(item)" class="text-xs font-bold text-orange-700 bg-white border border-orange-200 rounded px-2 py-1">
                                    <option value="walk">ğŸš¶ å¾’æ­¥</option>
                                    <option value="taxi">ğŸš• è¨ˆç¨‹è»Š</option>
                                    <option value="metro">ğŸš‡ åœ°éµ</option>
                                    <option value="shinkansen">ğŸš„ æ–°å¹¹ç·š</option>
                                    <option value="flight">âœˆï¸ é£›æ©Ÿ</option>
                                </select>
                                <input v-if="['metro', 'shinkansen'].includes(item.subType)" v-model="item.route" class="text-xs w-full bg-white border border-orange-100 rounded px-2 py-1 outline-none" placeholder="è·¯ç·šåç¨±...">
                                <div v-if="item.subType === 'flight'" class="grid grid-cols-2 gap-2">
                                    <input v-model="item.flightNo" class="text-xs bg-white border border-orange-100 rounded px-2 py-1 outline-none" placeholder="ç­æ¬¡">
                                    <input v-model="item.terminal" class="text-xs bg-white border border-orange-100 rounded px-2 py-1 outline-none" placeholder="èˆªå»ˆ">
                                </div>
                            </div>
                            
                            <textarea v-model="item.details" class="text-xs text-slate-500 bg-transparent w-full mt-2 resize-none outline-none border-t border-slate-50 pt-2" rows="1" placeholder="å‚™è¨»..."></textarea>
                        </div>
                    </div>
                </div>
            </transition-group>
            
            <div class="h-32"></div>
        </main>

        <div class="fixed bottom-24 right-6 flex flex-col gap-3">
            <button @click="addItem" class="bg-indigo-600 text-white p-4 rounded-full shadow-xl active:scale-95 transition">
                <i data-lucide="plus"></i>
            </button>
        </div>

        <nav class="h-20 border-t bg-white flex justify-around items-center shrink-0 z-40">
            <button class="text-indigo-600 flex flex-col items-center"><i data-lucide="calendar"></i><span class="text-[10px] mt-1">è¡Œç¨‹</span></button>
            <button class="text-slate-300 flex flex-col items-center"><i data-lucide="wallet"></i><span class="text-[10px] mt-1">è¨˜å¸³</span></button>
            <button class="text-slate-300 flex flex-col items-center"><i data-lucide="settings"></i><span class="text-[10px] mt-1">è¨­å®š</span></button>
        </nav>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                const currentDayIndex = ref(0);
                const itineraryData = ref([{ id: 1, items: [] }]);

                // æ ¸å¿ƒé‚è¼¯ï¼šè‡ªå‹•æ’åº
                const sortedItems = computed(() => {
                    const day = itineraryData.value[currentDayIndex.value];
                    if (!day) return [];
                    // ä½¿ç”¨ slice() è¤‡è£½é™£åˆ—é¿å…ç›´æ¥ä¿®æ”¹åŸå§‹æ•¸æ“šå°è‡´å¾ªç’°å ±éŒ¯
                    return day.items.slice().sort((a, b) => {
                        return timeToMin(a.start) - timeToMin(b.start);
                    });
                });

                onMounted(() => {
                    const saved = localStorage.getItem('tokyo_autosort_v1');
                    if (saved) itineraryData.value = JSON.parse(saved);
                    lucide.createIcons();
                });

                watch(itineraryData, () => {
                    localStorage.setItem('tokyo_autosort_v1', JSON.stringify(itineraryData.value));
                    nextTick(() => lucide.createIcons());
                }, { deep: true });

                const timeToMin = (t) => {
                    if(!t) return 0;
                    const [h, m] = t.split(':').map(Number);
                    return h * 60 + m;
                };

                const formatMin = (min) => {
                    if (min < 60) return `${min}m`;
                    return `${Math.floor(min/60)}h${min%60}m`;
                };

                const getGap = (prev, curr) => {
                    return timeToMin(curr.start) - timeToMin(prev.end);
                };

                const addItem = () => {
                    const lastItem = sortedItems.value[sortedItems.value.length - 1];
                    let start = '09:00';
                    let end = '10:00';
                    
                    if (lastItem) {
                        start = lastItem.end;
                        const [h, m] = start.split(':').map(Number);
                        end = `${String((h+1)%24).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
                    }

                    itineraryData.value[currentDayIndex.value].items.push({
                        id: Date.now() + Math.random(),
                        title: '',
                        start, end,
                        category: 'activity', subType: 'walk',
                        route: '', flightNo: '', terminal: '', details: ''
                    });
                };

                const removeItem = (id) => {
                    const idx = itineraryData.value[currentDayIndex.value].items.findIndex(i => i.id === id);
                    itineraryData.value[currentDayIndex.value].items.splice(idx, 1);
                };

                const autoTime = (item) => {
                    const sMin = timeToMin(item.start);
                    if (item.subType === 'walk') item.end = minToTime(sMin + 15);
                    if (item.subType === 'taxi') item.end = minToTime(sMin + 10);
                };

                const minToTime = (min) => {
                    const h = Math.floor(min / 60) % 24;
                    const m = min % 60;
                    return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                };

                const addDay = () => {
                    itineraryData.value.push({ id: Date.now(), items: [] });
                    currentDayIndex.value = itineraryData.value.length - 1;
                };

                return {
                    currentDayIndex, itineraryData, sortedItems,
                    addItem, removeItem, addDay, getGap, formatMin, autoTime
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
